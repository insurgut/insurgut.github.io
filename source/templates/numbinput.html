<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>number phone input</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body{margin:0;min-height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--tg-theme-bg-color,#000);color:var(--tg-theme-text-color,#fff);padding:1.5rem}
*{-webkit-tap-highlight-color:transparent;outline:none;box-sizing:border-box}
.phone-container{width:100%;max-width:320px}
.phone-input-wrapper{position:relative;display:flex;align-items:center;gap:.5rem;padding:.75rem .875rem;border-radius:10px;background:transparent;border:1px solid var(--tg-theme-section-separator-color,#1a1a1a);transition:border-color .15s;margin-top:6px}
.phone-input-wrapper::before{content:'';position:absolute;top:-1px;left:6px;width:80px;height:1px;background:var(--tg-theme-bg-color,#000);opacity:0;transition:opacity .15s}
.phone-input-wrapper:focus-within{border-color:var(--tg-theme-button-color,#3390ec)}
.phone-input-wrapper:focus-within::before{opacity:1}
.floating-label{position:absolute;left:.875rem;top:50%;transform:translateY(-50%);font-size:.8125rem;font-weight:400;color:#fff;pointer-events:none;transition:all .15s;white-space:nowrap}
.phone-input-wrapper:focus-within .floating-label,.has-value .floating-label{top:0px;left:6px;font-size:.625rem;font-weight:500;color:var(--tg-theme-button-color,#3390ec);padding:0 3px;background:var(--tg-theme-bg-color,#000)}
.country-title{position:absolute;right:.875rem;top:50%;transform:translateY(-50%);font-size:.8125rem;font-weight:400;color:#fff;pointer-events:none;transition:all .15s;opacity:0.7}
.phone-input-wrapper:focus-within .country-title,.has-value .country-title{top:-7px;transform:none;font-size:.625rem;font-weight:500;color:var(--tg-theme-button-color,#3390ec);padding:0 3px;background:var(--tg-theme-bg-color,#000);opacity:1}
.input-content{display:flex;align-items:center;gap:.5rem;flex:1}
.flag-container{display:flex;align-items:center;gap:.125rem;opacity:.85;transition:opacity .15s;flex-shrink:0}
.flag-img{width:1rem;height:1rem;border-radius:2px}
.flag-separator{font-size:.625rem;color:var(--tg-theme-hint-color,#666);opacity:.7;line-height:1}
.phone-input-wrapper:focus-within .flag-container{opacity:1}
.phone-input{flex:1;background:transparent;border:none;color:var(--tg-theme-text-color,#fff);font-size:.875rem;font-weight:400;font-family:inherit;min-width:0}
.phone-input::placeholder{color:transparent}
</style>
</head>
<body>
<div class="phone-container">
  <div class="phone-input-wrapper" id="wrapper">
    <span class="floating-label">Номер телефона</span>
    <span class="country-title" id="country-title">Загрузка...</span>
    <div class="input-content">
      <div class="flag-container" id="flag">
        <img class="flag-img" src="https://flagsapi.com/RU/flat/64.png" alt="Flag">
      </div>
      <input type="tel" class="phone-input" id="phone" placeholder=" " autocomplete="off" inputmode="tel" maxlength="20">
    </div>
  </div>
</div>
<script>
if (window.Telegram?.WebApp) {
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();
  Telegram.WebApp.setHeaderColor('bg_color');
}
let countries = [];
const wrapper = document.getElementById('wrapper');
const phoneInput = document.getElementById('phone');
const flagContainer = document.getElementById('flag');
const countryTitle = document.getElementById('country-title');
let currentCountry = null;
flagContainer.style.visibility = 'hidden';
fetch('https://insurgut.github.io/source/config/countriesn.json')
  .then(r => r.json())
  .then(data => {
    countries = data.map(c => ({...c, maxLen: (c.mask?.match(/x/g) || []).length}));
    const ru = countries.find(c => c.flag === 'ru');
    if (ru) ru.maxLen = 10;
    countryTitle.textContent = 'Россия / Казахстан';
    initDefault();
  })
  .catch(() => countryTitle.textContent = 'Ошибка загрузки');
function formatNumber(number, mask) {
  let result = '';
  let digitIdx = 0;
  let maskIdx = 0;
  while (digitIdx < number.length && maskIdx < mask.length) {
    const char = mask[maskIdx];
    if (char === 'x') result += number[digitIdx++];
    else result += char;
    maskIdx++;
  }
  return result;
}
function formatRussian(national) {
  if (national.length === 0) return '';
  let res = national.substring(0, Math.min(3, national.length));
  if (national.length >= 3) {
    res = '(' + res + ') ';
    let remaining = national.substring(3);
    if (remaining.length > 0) {
      res += remaining.substring(0, 3);
      if (remaining.length > 3) {
        res += '-' + remaining.substring(3, 5);
        if (remaining.length > 5) {
          res += '-' + remaining.substring(5, 7);
        }
      }
    }
  } else {
    res = '(' + res;
  }
  return res;
}
function detectCountry(num) {
  if (!num.startsWith('+') || !countries.length) return null;
  const digits = num.slice(1);
  let best = null;
  let maxLen = 0;
  for (const c of countries) {
    for (const code of c.codes || []) {
      if (digits.startsWith(code) && code.length > maxLen) {
        best = c;
        maxLen = code.length;
      }
    }
  }
  return best;
}
function updateCountry(c) {
  if (c?.flag === 'shared') {
    flagContainer.innerHTML = `<img class="flag-img" src="https://flagsapi.com/RU/flat/64.png">
       <span class="flag-separator">/</span>
       <img class="flag-img" src="https://flagsapi.com/KZ/flat/64.png">`;
    countryTitle.textContent = 'Россия / Казахстан';
    currentCountry = {flag: 'shared'};
    return;
  }
  currentCountry = c;
  if (!c) {
    flagContainer.innerHTML = '<img class="flag-img" src="https://flagsapi.com/UN/flat/64.png" alt="Globe">';
    flagContainer.style.opacity = '0.5';
    countryTitle.textContent = 'Неизвестная страна';
    return;
  }
  flagContainer.innerHTML = `<img class="flag-img" src="https://flagsapi.com/${c.flag.toUpperCase()}/flat/64.png">`;
  flagContainer.style.opacity = '';
  countryTitle.textContent = c.name_ru || c.name;
}
function setCursorPos(pos) {
  setTimeout(() => {
    const newPos = Math.min(pos, phoneInput.value.length);
    phoneInput.setSelectionRange(newPos, newPos);
  });
}
function handleInput() {
  const currentValue = phoneInput.value;
  const currentPos = phoneInput.selectionStart;
  let digitsBeforeCursor = 0;
  for (let i = 0; i < currentPos; i++) {
    if (/\d/.test(currentValue[i])) digitsBeforeCursor++;
  }
  let value = currentValue;
  if (!value.startsWith('+')) {
    value = '+' + value.replace(/[^\d]/g, '');
    phoneInput.value = value;
  }
  const cleanValue = '+' + value.slice(1).replace(/[^\d]/g, '');
  if (cleanValue === '+') {
    phoneInput.value = '+';
    updateCountry(null);
    wrapper.classList.remove('has-value');
    setCursorPos(1);
    return;
  }
  const country = detectCountry(cleanValue);
  if (country) {
    const code = country.codes[0].toString();
    const codeLen = code.length;
    let national = cleanValue.slice(1 + codeLen);
    national = national.substring(0, country.maxLen || 10);
    let formattedNational = '';
    let isShared = false;
    let targetCountry = country;
    const ru = countries.find(c => c.flag === 'ru');
    const kz = countries.find(c => c.flag === 'kz');
    if (code === '7' && ru && kz) {
      if (national.length === 0) {
        isShared = true;
        formattedNational = '';
      } else {
        if (national[0] === '7') {
          targetCountry = kz;
          formattedNational = formatNumber(national, kz.mask || '');
        } else {
          targetCountry = ru;
          formattedNational = formatRussian(national);
        }
      }
    } else {
      formattedNational = formatNumber(national, country.mask || '');
    }
    const prefix = `+${code} `;
    const prefixLen = prefix.length;
    let newFormatted = prefix + formattedNational;
    let nationalDigitsBefore = digitsBeforeCursor - codeLen;
    let newPos;
    if (nationalDigitsBefore <= 0) newPos = prefixLen;
    else {
      let nationalCount = 0;
      newPos = prefixLen;
      for (let i = prefixLen; i < newFormatted.length; i++) {
        newPos = i + 1;
        if (/\d/.test(newFormatted[i])) {
          nationalCount++;
          if (nationalCount >= nationalDigitsBefore) break;
        }
      }
    }
    phoneInput.value = newFormatted;
    if (isShared) updateCountry({flag: 'shared'});
    else updateCountry(targetCountry);
    setCursorPos(newPos);
  }
  wrapper.classList.toggle('has-value', phoneInput.value.length > 1);
}
function initDefault() {
  phoneInput.focus();
}
phoneInput.addEventListener('focus', () => {
  flagContainer.style.visibility = 'visible';
  if (phoneInput.value === '') {
    const ru = countries.find(c => c.flag === 'ru');
    if (ru) {
      phoneInput.value = '+7 ';
      updateCountry({flag: 'shared'});
      countryTitle.textContent = 'Россия / Казахстан';
      wrapper.classList.add('has-value');
      setCursorPos(3);
    }
  }
  if (phoneInput.value.length > 1) wrapper.classList.add('has-value');
  Telegram?.WebApp?.HapticFeedback?.impactOccurred('soft');
});
phoneInput.addEventListener('blur', () => {
  let val = phoneInput.value.trim();
  const cleanDigits = val.replace(/[^\d]/g, '');
  const country = detectCountry('+' + cleanDigits);
  let codeLen = country ? country.codes[0].length : 0;
  if (cleanDigits.length <= codeLen) {
    phoneInput.value = '';
    wrapper.classList.remove('has-value');
    flagContainer.style.visibility = 'hidden';
  }
});
phoneInput.addEventListener('keydown', (e) => {
  const pos = phoneInput.selectionStart;
  if ((e.key === 'Backspace' || e.key === 'Delete') && pos <= 1) {
    e.preventDefault();
    return;
  }
  if (e.key === 'Backspace' && phoneInput.value.startsWith('+7') && pos <= 3) {
    e.preventDefault();
    phoneInput.value = '+';
    wrapper.classList.remove('has-value');
    updateCountry(null);
    Telegram?.WebApp?.HapticFeedback?.impactOccurred('light');
    setCursorPos(1);
  }
});
phoneInput.addEventListener('input', handleInput);
phoneInput.addEventListener('paste', (e) => {
  e.preventDefault();
  let paste = (e.clipboardData || window.clipboardData).getData('text');
  paste = paste.replace(/[^\d]/g, '');
  if (paste) {
    phoneInput.value = '+' + paste;
    handleInput();
  }
});
setTimeout(() => { if (countries.length > 0) initDefault(); }, 200);
</script>
</body>
</html>
