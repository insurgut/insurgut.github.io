<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Adaptive Phone Input</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* --- НАСТРОЙКИ И ПЕРЕМЕННЫЕ --- */
:root {
    --tg-bg: var(--tg-theme-bg-color, #000);
    --tg-text: var(--tg-theme-text-color, #fff);
    --tg-hint: var(--tg-theme-hint-color, #999);
    --tg-accent: var(--tg-theme-button-color, #3390ec);
    --tg-border: var(--tg-theme-section-separator-color, #2f2f2f);
    
    /* Размеры */
    --input-height: 54px;
    --border-radius: 12px;
    --h-padding: 16px; /* Горизонтальный отступ внутри поля */
}

/* --- СБРОС И БАЗА --- */
* {
    -webkit-tap-highlight-color: transparent;
    outline: none;
    box-sizing: border-box;
}

body {
    margin: 0;
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background: var(--tg-bg);
    color: var(--tg-text);
    /* Адаптивный отступ от краев экрана */
    padding: clamp(1rem, 5vw, 2rem);
    overflow-x: hidden;
}

/* --- КОНТЕЙНЕР --- */
.phone-container {
    width: 100%;
    /* Максимальная ширина для планшетов/ПК, чтобы не растягивалось на 4k */
    max-width: 500px; 
    position: relative;
}

/* --- ОБЕРТКА ПОЛЯ (РАМКА) --- */
.phone-input-wrapper {
    position: relative;
    width: 100%;
    height: var(--input-height);
    display: flex;
    align-items: center;
    padding: 0 var(--h-padding);
    border-radius: var(--border-radius);
    background: transparent;
    border: 1px solid var(--tg-border);
    transition: all 0.2s ease;
    margin-top: 8px; /* Место под всплывающий лейбл, если что */
}

/* Разрыв рамки под лейбл */
.phone-input-wrapper::before {
    content: '';
    position: absolute;
    top: -1px;
    left: 10px; /* Отступ разрыва слева */
    width: 0;
    height: 1px;
    background: var(--tg-bg);
    transition: width 0.2s ease, opacity 0.2s ease;
    opacity: 0;
    pointer-events: none;
    z-index: 1;
}

/* --- СОСТОЯНИЯ (ФОКУС / ЗАПОЛНЕНО) --- */
/* Рамка становится синей при фокусе ИЛИ если есть значение (.has-value) */
.phone-input-wrapper:focus-within,
.phone-input-wrapper.has-value {
    border-color: var(--tg-accent);
    border-width: 1px; /* Можно поставить 2px для жирности, если хочется */
}

/* Активируем разрыв рамки */
.phone-input-wrapper:focus-within::before,
.phone-input-wrapper.has-value::before {
    width: 85px; /* Ширина "дырки" под текст лейбла */
    opacity: 1;
}

/* --- ЛЕЙБЛ (НАДПИСЬ) --- */
.floating-label {
    position: absolute;
    left: var(--h-padding);
    top: 50%;
    transform: translateY(-50%);
    font-size: 1rem;
    color: var(--tg-hint);
    pointer-events: none;
    transition: all 0.2s ease;
    background: transparent;
    padding: 0;
    z-index: 2;
}

/* Лейбл уезжает наверх */
.phone-input-wrapper:focus-within .floating-label,
.has-value .floating-label {
    top: -1px;
    left: 12px;
    transform: translateY(-50%);
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--tg-accent);
    padding: 0 4px; /* Чтобы перекрыть рамку по бокам */
    background: var(--tg-bg); /* Фон под текстом, чтобы скрыть линию */
}

/* --- НАЗВАНИЕ СТРАНЫ --- */
.country-title {
    position: absolute;
    right: var(--h-padding);
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.85rem;
    color: var(--tg-hint);
    pointer-events: none;
    transition: all 0.2s ease;
    opacity: 0; /* Скрыто по умолчанию, пока не активно */
    
    /* Обрезка длинного текста */
    max-width: 35%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: right;
}

/* Показываем название страны при фокусе/значении */
.phone-input-wrapper:focus-within .country-title,
.has-value .country-title {
    top: -10px;
    right: 12px;
    transform: none;
    font-size: 0.7rem;
    color: var(--tg-accent);
    background: var(--tg-bg);
    padding: 0 4px;
    opacity: 1;
    z-index: 2;
}

/* --- КОНТЕНТ ВНУТРИ --- */
.input-content {
    display: flex;
    align-items: center;
    width: 100%;
    height: 100%;
}

/* Флаги */
.flag-container {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-right: 10px;
    opacity: 0;
    transform: translateX(-5px);
    transition: all 0.2s ease;
    flex-shrink: 0; /* Чтобы флаг не сжимался */
}

/* Флаг показываем только при активности */
.phone-input-wrapper:focus-within .flag-container,
.has-value .flag-container {
    opacity: 1;
    transform: translateX(0);
}

.flag-img {
    width: 24px;
    height: 24px;
    border-radius: 50%; /* Круглые флаги выглядят современнее, можно убрать для квадратных */
    object-fit: cover;
    display: block;
}

.flag-separator {
    font-size: 14px;
    color: var(--tg-hint);
}

/* Само поле ввода */
.phone-input {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--tg-text);
    font-size: 16px; /* ВАЖНО: 16px предотвращает зум на iPhone */
    font-family: inherit;
    font-weight: 400;
    min-width: 0; /* Позволяет input сжиматься */
    padding: 0;
    margin: 0;
    height: 100%;
}

.phone-input::placeholder {
    color: transparent;
}

/* --- МЕДИА ЗАПРОСЫ (АДАПТИВНОСТЬ) --- */

/* Для очень узких экранов (iPhone SE 1gen, Galaxy Fold сложенный) */
@media (max-width: 340px) {
    :root {
        --h-padding: 10px;
        --input-height: 48px;
    }
    .floating-label {
        font-size: 0.9rem;
    }
    /* Скрываем название страны на микро-экранах, чтобы не мешало */
    .country-title {
        display: none; 
    }
}
</style>
</head>
<body>

<div class="phone-container">
  <div class="phone-input-wrapper" id="wrapper">
    <!-- Лейбл -->
    <span class="floating-label">Номер телефона</span>
    
    <!-- Название страны (сверху справа) -->
    <span class="country-title" id="country-title">Определение...</span>
    
    <div class="input-content">
      <!-- Флаг -->
      <div class="flag-container" id="flag">
        <img class="flag-img" src="https://flagsapi.com/RU/flat/64.png" alt="Flag">
      </div>
      
      <!-- Input -->
      <input type="tel" class="phone-input" id="phone" placeholder=" " autocomplete="off" inputmode="tel" maxlength="25">
    </div>
  </div>
</div>

<script>
/* Инициализация Telegram WebApp */
if (window.Telegram?.WebApp) {
  Telegram.WebApp.ready();
  Telegram.WebApp.expand(); // Растягиваем на весь экран
  // Делаем цвет хедера таким же как фон
  Telegram.WebApp.setHeaderColor(Telegram.WebApp.themeParams.bg_color || '#000000');
  Telegram.WebApp.setBackgroundColor(Telegram.WebApp.themeParams.bg_color || '#000000');
}

/* Логика скрипта (почти без изменений, но с оптимизацией) */
let countries = [];
const wrapper = document.getElementById('wrapper');
const phoneInput = document.getElementById('phone');
const flagContainer = document.getElementById('flag');
const countryTitle = document.getElementById('country-title');
let currentCountry = null;

// Флаг скрыт по умолчанию CSS-ом, но для логики инициализации:
flagContainer.style.visibility = 'hidden';

// Загрузка конфига стран
fetch('https://insurgut.github.io/source/config/countriesn.json')
  .then(r => r.json())
  .then(data => {
    countries = data.map(c => ({...c, maxLen: (c.mask?.match(/x/g) || []).length}));
    const ru = countries.find(c => c.flag === 'ru');
    if (ru) ru.maxLen = 10;
    countryTitle.textContent = ''; // Сброс
    initDefault();
  })
  .catch(() => countryTitle.textContent = 'Ошибка');

function formatNumber(number, mask) {
  let result = '';
  let digitIdx = 0;
  let maskIdx = 0;
  while (digitIdx < number.length && maskIdx < mask.length) {
    const char = mask[maskIdx];
    if (char === 'x') result += number[digitIdx++];
    else result += char;
    maskIdx++;
  }
  return result;
}

function formatRussian(national) {
  if (national.length === 0) return '';
  let res = national.substring(0, Math.min(3, national.length));
  if (national.length >= 3) {
    res = '(' + res + ') ';
    let remaining = national.substring(3);
    if (remaining.length > 0) {
      res += remaining.substring(0, 3);
      if (remaining.length > 3) {
        res += '-' + remaining.substring(3, 5);
        if (remaining.length > 5) {
          res += '-' + remaining.substring(5, 7);
        }
      }
    }
  } else {
    res = '(' + res;
  }
  return res;
}

function detectCountry(num) {
  if (!num.startsWith('+') || !countries.length) return null;
  const digits = num.slice(1);
  let best = null;
  let maxLen = 0;
  for (const c of countries) {
    for (const code of c.codes || []) {
      if (digits.startsWith(code) && code.length > maxLen) {
        best = c;
        maxLen = code.length;
      }
    }
  }
  return best;
}

function updateCountry(c) {
  flagContainer.style.visibility = 'visible';
  
  if (c?.flag === 'shared') {
    flagContainer.innerHTML = `<img class="flag-img" src="https://flagsapi.com/RU/flat/64.png">
       <span class="flag-separator">/</span>
       <img class="flag-img" src="https://flagsapi.com/KZ/flat/64.png">`;
    countryTitle.textContent = 'Россия / Казахстан';
    currentCountry = {flag: 'shared'};
    return;
  }
  currentCountry = c;
  if (!c) {
    flagContainer.innerHTML = '<img class="flag-img" src="https://flagsapi.com/UN/flat/64.png" style="opacity:0.5">';
    countryTitle.textContent = 'Неизвестно';
    return;
  }
  flagContainer.innerHTML = `<img class="flag-img" src="https://flagsapi.com/${c.flag.toUpperCase()}/flat/64.png">`;
  countryTitle.textContent = c.name_ru || c.name;
}

function setCursorPos(pos) {
  setTimeout(() => {
    const newPos = Math.min(pos, phoneInput.value.length);
    phoneInput.setSelectionRange(newPos, newPos);
  });
}

function handleInput() {
  const currentValue = phoneInput.value;
  const currentPos = phoneInput.selectionStart;
  
  // Подсчет цифр до курсора для восстановления позиции
  let digitsBeforeCursor = 0;
  for (let i = 0; i < currentPos; i++) {
    if (/\d/.test(currentValue[i])) digitsBeforeCursor++;
  }

  let value = currentValue;
  // Авто-плюс
  if (!value.startsWith('+')) {
    value = '+' + value.replace(/[^\d]/g, '');
    phoneInput.value = value;
  }

  const cleanValue = '+' + value.slice(1).replace(/[^\d]/g, '');
  
  if (cleanValue === '+') {
    phoneInput.value = '+';
    updateCountry(null);
    wrapper.classList.remove('has-value'); // Убираем акцент, если только плюс
    setCursorPos(1);
    return;
  }

  // Если есть цифры кроме плюса - добавляем класс has-value
  if (cleanValue.length > 1) {
    wrapper.classList.add('has-value');
  }

  const country = detectCountry(cleanValue);
  if (country) {
    const code = country.codes[0].toString();
    const codeLen = code.length;
    let national = cleanValue.slice(1 + codeLen);
    
    // Лимит длины
    national = national.substring(0, country.maxLen || 15);

    let formattedNational = '';
    let isShared = false;
    let targetCountry = country;
    
    const ru = countries.find(c => c.flag === 'ru');
    const kz = countries.find(c => c.flag === 'kz');

    // Спец-логика для +7 (РФ/КЗ)
    if (code === '7' && ru && kz) {
      if (national.length === 0) {
        isShared = true;
      } else {
        if (national[0] === '7') {
          targetCountry = kz;
          formattedNational = formatNumber(national, kz.mask || '');
        } else {
          targetCountry = ru;
          formattedNational = formatRussian(national);
        }
      }
    } else {
      formattedNational = formatNumber(national, country.mask || '');
    }

    const prefix = `+${code} `;
    const prefixLen = prefix.length;
    let newFormatted = prefix + formattedNational;

    // Восстановление позиции курсора
    let nationalDigitsBefore = digitsBeforeCursor - codeLen;
    let newPos;
    if (nationalDigitsBefore <= 0) newPos = prefixLen;
    else {
      let nationalCount = 0;
      newPos = prefixLen;
      for (let i = prefixLen; i < newFormatted.length; i++) {
        newPos = i + 1;
        if (/\d/.test(newFormatted[i])) {
          nationalCount++;
          if (nationalCount >= nationalDigitsBefore) break;
        }
      }
    }
    
    phoneInput.value = newFormatted;
    if (isShared) updateCountry({flag: 'shared'});
    else updateCountry(targetCountry);
    setCursorPos(newPos);
  }
}

function initDefault() {
  // Не вызываем focus() автоматически на мобильных, чтобы не открывать клавиатуру
}

/* Обработчики событий */

// Фокус: показываем флаг, ставим +7 если пусто
phoneInput.addEventListener('focus', () => {
  if (phoneInput.value === '') {
    const ru = countries.find(c => c.flag === 'ru');
    if (ru) {
      phoneInput.value = '+7 ';
      updateCountry({flag: 'shared'});
      wrapper.classList.add('has-value');
      setCursorPos(3);
    }
  } else {
    wrapper.classList.add('has-value');
  }
  // Вибрация при тапе
  Telegram?.WebApp?.HapticFeedback?.impactOccurred('soft');
});

// Блюр: проверяем пусто ли
phoneInput.addEventListener('blur', () => {
  let val = phoneInput.value.trim();
  const cleanDigits = val.replace(/[^\d]/g, '');
  const country = detectCountry('+' + cleanDigits);
  let codeLen = country ? country.codes[0].length : 0;

  // Если удалили все цифры номера (остался только код или меньше)
  if (cleanDigits.length <= codeLen) {
    phoneInput.value = '';
    wrapper.classList.remove('has-value'); // Убираем акцент рамки
    flagContainer.style.visibility = 'hidden';
  } else {
    // Если номер есть, рамка остается акцентной (.has-value остается)
  }
});

phoneInput.addEventListener('keydown', (e) => {
  const pos = phoneInput.selectionStart;
  // Запрет удаления плюса
  if ((e.key === 'Backspace' || e.key === 'Delete') && pos <= 1) {
    e.preventDefault();
    return;
  }
  // Быстрое удаление +7
  if (e.key === 'Backspace' && phoneInput.value.startsWith('+7') && pos <= 3) {
    e.preventDefault();
    phoneInput.value = '+';
    wrapper.classList.remove('has-value');
    updateCountry(null);
    Telegram?.WebApp?.HapticFeedback?.impactOccurred('light');
    setCursorPos(1);
  }
});

phoneInput.addEventListener('input', handleInput);

// Обработка вставки номера
phoneInput.addEventListener('paste', (e) => {
  e.preventDefault();
  let paste = (e.clipboardData || window.clipboardData).getData('text');
  paste = paste.replace(/[^\d]/g, '');
  if (paste) {
    phoneInput.value = '+' + paste;
    handleInput();
  }
});

setTimeout(() => { if (countries.length > 0) initDefault(); }, 200);
</script>
</body>
</html>
