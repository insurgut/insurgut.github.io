<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Fixed Phone Input</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
    --tg-bg: var(--tg-theme-bg-color, #000);
    --tg-text: var(--tg-theme-text-color, #fff);
    --tg-accent: var(--tg-theme-button-color, #3390ec);
    --radius: 12px;
}
body {
    margin: 0; min-height: 100dvh; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
    background: var(--tg-bg); color: var(--tg-text);
    padding: clamp(1rem, 5vw, 2rem);
}
.phone-container { width: 100%; max-width: 500px; position: relative; }
.phone-input-wrapper {
    position: relative; width: 100%; height: 54px; display: flex;
    align-items: center; padding: 0 16px;
    border-radius: var(--radius); background: transparent;
    border: 2px solid var(--tg-accent);
    margin-top: 8px; transition: all .2s ease;
}
.phone-input-wrapper::before {
    content: ''; position: absolute; top: -2px; left: 10px;
    width: 0; height: 2px; background: var(--tg-bg);
    transition: width .2s ease, opacity .2s ease;
    opacity: 0; pointer-events: none; z-index: 1;
}
.phone-input-wrapper:focus-within::before, .phone-input-wrapper.has-value::before {
    width: 85px; opacity: 1;
}
.floating-label {
    position: absolute; left: 16px; top: 50%;
    transform: translateY(-50%); font-size: 1rem;
    color: var(--tg-accent); opacity: 0.7;
    pointer-events: none; transition: all .2s ease; z-index: 2;
}
.phone-input-wrapper:focus-within .floating-label, .has-value .floating-label {
    top: -2px; left: 12px; font-size: 0.75rem; font-weight: 600;
    opacity: 1; padding: 0 4px; background: var(--tg-bg);
}
.country-title {
    position: absolute; right: 16px; top: 50%;
    transform: translateY(-50%); font-size: 0.85rem;
    color: var(--tg-accent); opacity: 0;
    pointer-events: none; transition: all .2s ease;
    max-width: 35%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.phone-input-wrapper:focus-within .country-title, .has-value .country-title {
    top: -11px; right: 12px; transform: none; font-size: 0.7rem;
    background: var(--tg-bg); padding: 0 4px; opacity: 1; z-index: 2;
}
.input-content { display: flex; align-items: center; width: 100%; height: 100%; }
.flag-container {
    display: flex; align-items: center; gap: 4px; margin-right: 10px;
    opacity: 0; transform: translateX(-5px); transition: all .2s ease; flex-shrink: 0;
}
.phone-input-wrapper:focus-within .flag-container, .has-value .flag-container {
    opacity: 1; transform: translateX(0);
}
.flag-img { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; }
.phone-input {
    flex: 1; background: transparent; border: none; color: var(--tg-text);
    font-size: 16px; font-family: inherit; min-width: 0; height: 100%; padding: 0;
}
.phone-input::placeholder { color: transparent; }
@media (max-width: 340px) {
    .floating-label { font-size: 0.9rem; }
    .country-title { display: none; }
}
</style>
</head>
<body>
<div class="phone-container">
  <div class="phone-input-wrapper" id="wrapper">
    <span class="floating-label">Номер телефона</span>
    <span class="country-title" id="country-title"></span>
    <div class="input-content">
      <div class="flag-container" id="flag"></div>
      <input type="tel" class="phone-input" id="phone" placeholder=" " autocomplete="off" inputmode="tel" maxlength="25">
    </div>
  </div>
</div>
<script>
if (window.Telegram?.WebApp) {
  Telegram.WebApp.ready(); Telegram.WebApp.expand();
  Telegram.WebApp.setHeaderColor(Telegram.WebApp.themeParams.bg_color || '#000000');
  Telegram.WebApp.setBackgroundColor(Telegram.WebApp.themeParams.bg_color || '#000000');
}
let countries = [];
const wrapper = document.getElementById('wrapper');
const phoneInput = document.getElementById('phone');
const flagContainer = document.getElementById('flag');
const countryTitle = document.getElementById('country-title');
flagContainer.style.visibility = 'hidden';

fetch('https://insurgut.github.io/source/config/countriesn.json')
  .then(r => r.json()).then(data => {
    countries = data.map(c => ({...c, maxLen: (c.mask?.match(/x/g) || []).length}));
    const ru = countries.find(c => c.flag === 'ru');
    if (ru) ru.maxLen = 10;
  }).catch(() => countryTitle.textContent = 'Ошибка');

const formatNumber = (num, mask) => {
  let res = '', dIdx = 0, mIdx = 0;
  while (dIdx < num.length && mIdx < mask.length) {
    res += mask[mIdx] === 'x' ? num[dIdx++] : mask[mIdx];
    mIdx++;
  }
  return res;
};
const formatRussian = (nat) => {
  if (!nat.length) return '';
  let res = nat.substring(0, Math.min(3, nat.length));
  if (nat.length >= 3) {
    res = `(${res}) ` + nat.substring(3, 6);
    if (nat.length > 6) res += '-' + nat.substring(6, 8);
    if (nat.length > 8) res += '-' + nat.substring(8, 10);
  } else res = '(' + res;
  return res;
};
const detectCountry = (clean) => {
  if (!countries.length || clean.length < 2) return null;
  const d = clean.slice(1);
  let best = null, max = 0;
  for (const c of countries) {
    for (const code of c.codes || []) {
      if (d.startsWith(code) && code.length > max) { best = c; max = code.length; }
    }
  }
  return best;
};
const updateCountry = (c) => {
  flagContainer.style.visibility = 'visible';
  if (c?.flag === 'shared') {
    flagContainer.innerHTML = `<img class="flag-img" src="https://flagsapi.com/RU/flat/64.png"><img class="flag-img" src="https://flagsapi.com/KZ/flat/64.png">`;
    countryTitle.textContent = 'Россия / Казахстан';
    return;
  }
  if (!c) {
    flagContainer.innerHTML = '<img class="flag-img" src="https://flagsapi.com/UN/flat/64.png" style="opacity:0.5">';
    countryTitle.textContent = '';
    return;
  }
  flagContainer.innerHTML = `<img class="flag-img" src="https://flagsapi.com/${c.flag.toUpperCase()}/flat/64.png">`;
  countryTitle.textContent = c.name_ru || c.name;
};
const setCursor = (pos) => setTimeout(() => {
  const p = Math.min(pos, phoneInput.value.length);
  phoneInput.setSelectionRange(p, p);
});

const handleInput = () => {
  const val = phoneInput.value;
  const curPos = phoneInput.selectionStart;
  let digitsBefore = 0;
  for (let i = 0; i < curPos; i++) if (/\d/.test(val[i])) digitsBefore++;
  
  // Исправленная строка: просто удаляем всё кроме цифр и добавляем плюс
  const clean = '+' + val.replace(/\D/g, '');
  
  if (clean === '+' || clean === '') {
    phoneInput.value = '+';
    updateCountry(null);
    wrapper.classList.add('has-value');
    setCursor(1);
    return;
  }
  
  wrapper.classList.add('has-value');
  const country = detectCountry(clean);
  
  if (country) {
    const code = country.codes[0].toString();
    // Проверяем, что введенные цифры совпадают с кодом страны, иначе форматирование ломается
    if (!clean.slice(1).startsWith(code)) {
        phoneInput.value = clean;
        return;
    }
    
    let nat = clean.slice(1 + code.length).substring(0, country.maxLen || 15);
    let fmt = '', isShared = false, target = country;
    const ru = countries.find(c => c.flag === 'ru'), kz = countries.find(c => c.flag === 'kz');
    
    if (code === '7' && ru && kz) {
      if (!nat.length) isShared = true;
      else if (nat[0] === '7') { target = kz; fmt = formatNumber(nat, kz.mask || ''); }
      else { target = ru; fmt = formatRussian(nat); }
    } else fmt = formatNumber(nat, country.mask || '');
    
    const prefix = `+${code} `, newFmt = prefix + fmt;
    let newPos = prefix.length, count = 0, targetDigits = digitsBefore - code.length;
    
    if (targetDigits > 0) {
      for (let i = prefix.length; i < newFmt.length; i++) {
        newPos = i + 1;
        if (/\d/.test(newFmt[i]) && ++count >= targetDigits) break;
      }
    }
    phoneInput.value = newFmt;
    updateCountry(isShared ? {flag:'shared'} : target);
    setCursor(newPos);
  } else {
    phoneInput.value = clean;
    updateCountry(null);
  }
};

phoneInput.addEventListener('focus', () => {
  if (phoneInput.value === '') phoneInput.value = '+';
  wrapper.classList.add('has-value');
  Telegram?.WebApp?.HapticFeedback?.impactOccurred('soft');
});

phoneInput.addEventListener('blur', () => {
  const clean = phoneInput.value.replace(/\D/g, '');
  if (clean.length === 0) {
    phoneInput.value = '';
    wrapper.classList.remove('has-value');
    flagContainer.style.visibility = 'hidden';
  }
});

phoneInput.addEventListener('keydown', (e) => {
  if ((e.key === 'Backspace' || e.key === 'Delete') && phoneInput.selectionStart <= 1 && phoneInput.value.length <= 1) {
    e.preventDefault();
  }
});

phoneInput.addEventListener('input', handleInput);
phoneInput.addEventListener('paste', (e) => {
  e.preventDefault();
  const paste = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g, '');
  if (paste) { phoneInput.value = '+' + paste; handleInput(); }
});
</script>
</body>
</html>
