name: TG Deploy
on:
  push:
    paths: ['source/**']
jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Process & Send
        env:
          TOKEN: ${{ secrets.TOKEN }}
          CHAT_ID: "6222585321"
        run: |
          # Не падать при ошибках
          set +e
          
          TRIMMED_TOKEN=$(echo "$TOKEN" | tr -d '\n' | tr -d '\r')
          git config core.quotePath false

          # Диапазон
          if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            RANGE="HEAD~1 HEAD"
          else
            RANGE="4b825dc642cb6eb9a060e54bf8d69288fbee4904 HEAD"
          fi

          # Цикл
          git diff --diff-filter=ACMRT --name-only $RANGE -- source/ | while read -r FILE; do
            echo "---------------------------------------------------"
            echo "Processing: $FILE"
            
            if [ ! -f "$FILE" ] || [ ! -s "$FILE" ]; then continue; fi

            # --- 1. ПОЛУЧЕНИЕ ДАННЫХ ---
            
            # Старая версия
            if git cat-file -e "HEAD~1:$FILE" 2>/dev/null; then
              L_OLD=$(git show "HEAD~1:$FILE" | wc -l)
              # Ищем: version = "..." или __version__ = '...' (регистр не важен)
              V_OLD=$(git show "HEAD~1:$FILE" | grep -iP -o "(?:version|__version__)\s*=\s*['\"]\K[^'\"]+" | head -1)
            else
              L_OLD="0"
              V_OLD="New"
            fi
            
            # Новая версия
            L_NEW=$(wc -l < "$FILE")
            V_NEW=$(grep -iP -o "(?:version|__version__)\s*=\s*['\"]\K[^'\"]+" "$FILE" | head -1)
            
            # Заглушки, если версия не найдена в коде
            if [ -z "$V_OLD" ]; then V_OLD="?"; fi
            if [ -z "$V_NEW" ]; then V_NEW="?"; fi

            # --- 2. ПОДГОТОВКА HTML ---
            
            # Экранирование для HTML (ОЧЕНЬ ВАЖНО)
            # Заменяем & < > " на безопасные аналоги
            COMMIT_MSG=$(git log -1 --pretty=%s | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')
            
            COMMIT_URL="https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"
            FILE_URL="https://github.com/$GITHUB_REPOSITORY/blob/$GITHUB_SHA/$FILE"
            
            # СТРОИМ ПОДПИСЬ (Строго в одну строку для переменной, но с тегами переноса)
            # Вид:
            # | Ссылка на коммит
            # | vOld -> vNew • 10L -> 20L
            CAP="<blockquote><a href=\"$COMMIT_URL\">$COMMIT_MSG</a>&#10;&#10;Ver: $V_OLD ➝ <a href=\"$FILE_URL\">$V_NEW</a> • Lines: ${L_OLD}L ➝ ${L_NEW}L</blockquote>"

            echo "Sending Payload..."

            # --- 3. ОТПРАВКА ---
            
            curl -v -F chat_id="$CHAT_ID" \
                 -F document=@"$FILE" \
                 -F parse_mode="HTML" \
                 -F caption="$CAP" \
                 "https://api.telegram.org/bot$TRIMMED_TOKEN/sendDocument" > response.json 2> curl_log.txt || true
            
            # --- 4. ПРОВЕРКА ---
            
            if ! grep -q '"ok":true' response.json; then
                echo "::error::Primary HTML Upload Failed!"
                
                # Вывод ошибки в лог Github (чтобы мы поняли причину)
                echo "Server Response:"
                cat response.json
                
                # ОТПРАВКА ЗАПАСНОГО ВАРИАНТА (Только если HTML сломался)
                echo "Retrying plain text..."
                SIMPLE_CAP="File: $FILE | Ver: $V_NEW"
                
                curl -s -F chat_id="$CHAT_ID" \
                     -F document=@"$FILE" \
                     -F caption="$SIMPLE_CAP" \
                     "https://api.telegram.org/bot$TRIMMED_TOKEN/sendDocument" || true
            else
                echo "SUCCESS: Sent $FILE"
            fi
          done
          
          exit 0
