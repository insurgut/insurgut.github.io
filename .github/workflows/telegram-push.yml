name: TG Deploy
on:
  push:
    paths: ['source/**']
jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Process & Send
        env:
          TOKEN: ${{ secrets.TOKEN }}
          CHAT_ID: "6222585321"
        run: |
          set +e
          
          TRIMMED_TOKEN=$(echo "$TOKEN" | tr -d '\n' | tr -d '\r')
          git config core.quotePath false

          # 1. Данные
          SHORT_SHA=$(git rev-parse --short HEAD)
          COMMIT_URL="https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"
          # Время МСК (UTC+3)
          TIME=$(TZ=Europe/Moscow date "+%Y-%m-%d %H:%M:%S")

          # 2. Диапазон
          if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            RANGE="HEAD~1 HEAD"
          else
            RANGE="4b825dc642cb6eb9a060e54bf8d69288fbee4904 HEAD"
          fi

          # 3. Отправка
          git diff --diff-filter=ACMRT --name-only $RANGE -- source/ | while read -r FILE; do
            echo "Processing: $FILE"
            if [ ! -f "$FILE" ] || [ ! -s "$FILE" ]; then continue; fi

            # --- ФОРМИРОВАНИЕ СООБЩЕНИЯ ---
            # Используем одинарные кавычки для href, чтобы Bash не ломал строку
            # Вид: a0d3c61 • 2025-12-08 12:00:00
            
            CAP="<a href='$COMMIT_URL'>$SHORT_SHA</a> • $TIME"

            echo "Generated Caption: $CAP"

            # --- ОТПРАВКА ---
            curl -v -F chat_id="$CHAT_ID" \
                 -F document=@"$FILE" \
                 -F parse_mode="HTML" \
                 -F caption="$CAP" \
                 "https://api.telegram.org/bot$TRIMMED_TOKEN/sendDocument" > response.json 2> curl_log.txt || true
            
            # --- ПРОВЕРКА ---
            if ! grep -q '"ok":true' response.json; then
                echo "::error::Upload Failed for $FILE"
                cat response.json
                
                # Если HTML не прошел - отправляем текстом ошибку, чтобы вы видели причину
                # Не шлем файл повторно, чтобы не спамить дублями
                ERR_TEXT="⚠️ <b>Deploy Error</b>%0AFile: $FILE%0ATelegram rejected HTML link."
                
                curl -s -X POST "https://api.telegram.org/bot$TRIMMED_TOKEN/sendMessage" \
                     -d chat_id="$CHAT_ID" \
                     -d parse_mode="HTML" \
                     -d text="$ERR_TEXT" || true
            else
                echo "SUCCESS: Sent $FILE"
            fi
          done
          
          exit 0
