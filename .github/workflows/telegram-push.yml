name: TG Deploy
on:
  push:
    paths: ['source/**']
jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Process & Send
        env:
          TOKEN: ${{ secrets.TOKEN }}
          CHAT_ID: "6222585321"
        run: |
          # –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–∞–¥–µ–Ω–∏—è
          set +e
          
          TRIMMED_TOKEN=$(echo "$TOKEN" | tr -d '\n' | tr -d '\r')
          git config core.quotePath false

          # 1. –ü–û–î–ì–û–¢–û–í–ö–ê –û–ë–©–ò–• –î–ê–ù–ù–´–•
          # –ö–æ—Ä–æ—Ç–∫–∏–π —Ö–µ—à (–Ω–∞–ø—Ä–∏–º–µ—Ä a0d3c61)
          SHORT_SHA=$(git rev-parse --short HEAD)
          
          # –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–º–º–∏—Ç
          COMMIT_URL="https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"
          
          # –¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è (UTC)
          TIME=$(date "+%Y-%m-%d %H:%M:%S UTC")

          # –î–∏–∞–ø–∞–∑–æ–Ω –∏–∑–º–µ–Ω–µ–Ω–∏–π
          if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            RANGE="HEAD~1 HEAD"
          else
            RANGE="4b825dc642cb6eb9a060e54bf8d69288fbee4904 HEAD"
          fi

          # 2. –¶–ò–ö–õ –ü–û –§–ê–ô–õ–ê–ú
          # --diff-filter=ACMRT –∏—Å–∫–ª—é—á–∞–µ—Ç —É–¥–∞–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–æ–∫
          git diff --diff-filter=ACMRT --name-only $RANGE -- source/ | while read -r FILE; do
            echo "Processing: $FILE"
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è
            if [ ! -f "$FILE" ] || [ ! -s "$FILE" ]; then continue; fi

            # 3. –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –ü–û–î–ü–ò–°–ò (HTML)
            # &#10; - —ç—Ç–æ –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
            # –í–∏–¥ —Å–æ–æ–±—â–µ–Ω–∏—è:
            # üìÇ source/1.py
            # üîó Commit: a0d3c61
            # üïí Time: 2023-12-08 12:00:00
            
            CAP=" &#10;<a href=\"$COMMIT_URL\">$SHORT_SHA</a> ‚Ä¢ &#10;$TIME"

            echo "Sending $FILE..."

            # 4. –û–¢–ü–†–ê–í–ö–ê
            curl -v -F chat_id="$CHAT_ID" \
                 -F document=@"$FILE" \
                 -F parse_mode="HTML" \
                 -F caption="$CAP" \
                 "https://api.telegram.org/bot$TRIMMED_TOKEN/sendDocument" > response.json 2> curl_log.txt || true
            
            # 5. –ü–†–û–í–ï–†–ö–ê –ù–ê –û–®–ò–ë–ö–ò
            if ! grep -q '"ok":true' response.json; then
                echo "::error::Failed to send $FILE"
                cat response.json
                
                # –ï—Å–ª–∏ HTML –Ω–µ –ø—Ä–æ—à–µ–ª, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º "–≥–æ–ª—ã–π" —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –≤—ã —Ç–æ—á–Ω–æ –ø–æ–ª—É—á–∏–ª–∏ —Ñ–∞–π–ª
                SIMPLE_CAP="File: $FILE | Commit: $SHORT_SHA | Time: $TIME"
                
                curl -s -F chat_id="$CHAT_ID" \
                     -F document=@"$FILE" \
                     -F caption="$SIMPLE_CAP" \
                     "https://api.telegram.org/bot$TRIMMED_TOKEN/sendDocument" || true
            else
                echo "SUCCESS: Sent $FILE"
            fi
          done
          
          exit 0
